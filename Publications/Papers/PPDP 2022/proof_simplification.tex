\section{Proof simplification using user inputed facts for Comp encoding}\label{sec:proof_simplification}
\subsection{Definition 1 - Abstract Proof graph}
Given a rule set $R$ satisfying condition 4 from above but possibly having
NAF, and a predicate $p$ and integer $n$ define the abstract proof graph
$G_{R,p,n}$ as follows. The nodes of $G_{R,p,n}$ is the set of $query$
predicates generated by the rules $AG1$ and $AG3$. when in
$\langle R,q,U,C,N\rangle$, $q$ is $p(v1,v2..,vk)$ where $p$ has arity $k$,
$U$, $C$ are empty and $N = n+1$. The edge relation is defined as follows. Two
nodes $d1$, $d2$ are connected by a directed edge represented as $E(d1,d2)$ if
and only if, $d1$ represents a pre-condition of an input rule where $d2$ is
the post condition.

So if $R'$ consisted to the single rule:
\begin{verbatim}
a(X):-b(X,Y),a(Y)
\end{verbatim}
Then $G_{R',a,2}$ is:
\begin{verbatim}
E(query(b(v1,sk(v1)),1),query(a(v1),0)),
E(query(a(sk(v1)),1),query(a(v1),0)))
E(query(b(sk(v1),sk(sk(v1))),2),query(a(sk(v1)),1)),
E(query(a(sk(sk(v1))),2),query(a(sk(v1)),1)) \end{verbatim}
Here $sk$ is just an abbreviation of the full skolem function name. 
Given an abstract proof graph $G_{R',p,N}$, construct the minimal proof graph $G_{R',p,N}^{min}$ as follows. Firstly for given an integer $k$, going from left to right, delete all duplicate nodes $query(a',k)$ such that $query(a,k)$ is already in the proof graph and $a'=a$. Next for going down the proof graph, for each $k\in {0,1...,N}$, delete the node $query(a,k)$, if there exists $l<k$, such that $query(a',l)$ is in the proof graph $a=a'$. This forms $G_{R',p,N}^{min}$. The edge relation is inherited from $G_{R,p,N}$ in the obvious way. Note firstly that if for some $b,j$, $query(b,j)$ is in $G_{R',p,N}$, then there exists some $h\leq j$ such that $query(b,h)$ is in $G_{R',p,N}^{min}$. Secondly we have the following property:
\begin{lemma}
Given $query(a,k)$ in $G_{R',p,N}^{min}$, unless $k=0$, there exists $query(a',j)$ in $G_{R',p,N}^{min}$ such that we have $E(query(a,k),query(a',j))$.  
\end{lemma}
$\textit{Proof sketch}$ Let $query(a'',j')$ be such that $E(query(a,k),query(a'',j'))$ in $G_{R',p,N}$. Now if $query(a'',j')$ is not in $G_{R',p,N}^{min}$, then there exists $s<j'$ such that $query(a'',s)$ is in $G_{R',p,N}^{min}$, but then there exists $t<k$ such that $query(a,t)$ is in $G_{R',p,N}^{min}$. However this is a contradiction. Hence it must be the case that $query(a'',j')$ is in $G_{R',p,N}^{min}$. 



\subsection{Definition 2 - Concrete Proof graph}

Given an abstract proof graph $G_{R,p,n}^{min}$, and a substitution $\theta$ for
terms in the abstract proof graph, define the concrete proof graph
$C_{R,p,n,\theta}$ to be the set of $query$ atoms obtained after doing the
substitution $\theta$ on the set of $query$ atoms in $G_{R,p,n}^{min}$. (We drop the $min$ from the notation for the concrete proof graph as we will always mean a substitution from the minimal abstract proof graph)

For example given the substitution $\phi$ $[v1\rightarrow john, sk(v1)
\rightarrow james, sk(sk(v1))\rightarrow mary]$, $C_{R',a,2,\phi}$ is :

\begin{verbatim}
query(a(john),0), query(b(john,james),1), query(a(james),1)
query(b(james,mary),2), query(a(mary),2) \end{verbatim}
Note that such a substitution $\phi$ need not be injective.


\subsection{Definition 3 - Derived substitution}
Given some $G_{R,p,n}^{min}$, and an associated $C_{R,p,n,\theta}$, let $q_{c}$ be a $query$ atom from $C_{R,p,n,\theta}$. Let $S_{q_{c}}$ be the set of $query$ atoms in $G_{R,p,n}^{min}$, which upon application of the substitution $\theta$ give $q_{c}$. Now pick an atom $q_{o}$ from $S_{q_{c}}$. Now suppose $q_{c}$ is given by $query((t_{1},t_{2},...,t_{j}),k)$, $q_{o}$ is given by $query((e_{1},e_{2},...,e_{j}),k)$. Now consider an arbitrary query atom $q_{f}$ given by $query((a_{1},a_{2},...,a_{j}),k)$, which is such that the map $\psi$ mapping each $e_{i}$ to the corresponding $a_{i}$ is well defined. (ie. $\psi$ is not one-to-many). Then define the substituion $\phi = T(\theta, q_{c},q_{o},q_{f})$ on terms in $G_{R,p,n}^{min}$ by the following:\\ For a term $u$ in $G_{R,p,n}^{min}$ (meaning $u$ occurs as the argument of the predicate inside some $query$ atom), if $u$ is in the set $\{e_{1},e_{2},...,e_{j}\}$ then $\phi(u) = \psi(u)$, otherwise $\phi(u) = \theta(u)$.

\begin{theorem}[Term substitution]\label{thm:termsub}
Given a rule set $R$ satisfying condition 4 from above consider $\langle R,q,U,C,N\rangle$,
let $p$ be the predicate corresponding to $q$. Suppose $A$ is an answer set of
$P^{semi-complete}_{<R,q,U,C,N>}$ and let $A$ contain $C_{R,p,N,\theta}$. Now
say the atom $q_{c}$ $query(p_{i}(t_{1},t_{2},..,t_{j}),k)$ is in
$C_{R,p,N,\theta}$. Let $q_{o}$ be some query atom from the set $S_{q_{c}}$
given by $query((e_{1},e_{2},...,e_{j}),k)$. Now suppose, $q_{f}=
query((a_{1},a_{2},...,a_{j}),k)$ is an arbitrary $query$ atom such that the
map $\psi$ from the $e_{i}s$ to the $a_{i}s$ as described in the definition
above is well defined. Then upon adding the fact
$query(p_{i}(a_{1},a_{2},..,a_{j}),k)$ to $P^{semi-complete}_{<R,q,U,C,N>}$,
the resulting program has an answer set $A'$ such that $A'$ contains
$C_{R,p,N,\phi}$, where $\phi = T(\theta, q_{c}, q_{o}, q_{f})$.
\end{theorem}

$\textit{Proof sketch}$. In the following proof when we refer to the $level$ of a $query$ atom we mean the integer argument of the $query$ atom. When we refer to the $predicate$ $argument$ of a $query$ atom we will mean the first argument of a $query$ atom. Given a $query$ atom $q$ in $G_{R,p,N}^{min}$, the transformed atom $tr_{\chi}(q)$ denotes the corresponding atom in $C_{R,p,N,\chi}$, given some substitution $\chi$ of terms in $G_{R,p,N}^{min}$. We will prove the result by induction on $k$, the level of the atoms $q_{c}$, $q_{o}$ and $q_{f}$. 

Fix $q_{c}$, $q_{o}$ and $q_{f}$ and suppose that the level of these atoms $k$ is $0$. Since there is only one level $0$ query atom say $q'$ in $G_{R,p,N}$, we must have $q_{o}=q'$, and $q_{f} = tr_{\phi}(q')$. Now we have to show that for all $query$ atoms $q$ in $G_{R,p,N}$ such that the level of $q$ is greater than $0$, we have $tr_{\phi}(q)$. Now suppose that $p$ is a 3 place predicate and there is an input rule $r_{c}$ where ${c}$ refers to the rule id. Suppose that the predicate $p_{d}$ appears as a pre-condition in $r_{c}$. Let the variables in $r_{c}$ be $X1$, $X2$, $X3$, $X4$, in the order given by $O_{c}$, (recall from Section \ref{ruletrans} that for each input rule we had some order on the variables). Suppose $r_{c}$ has the following form:
\begin{verbatim}
p(X2,X1,X4):-p_d(X4,X2,X3),...    
\end{verbatim}

Then in $C_{R,p,N,\theta}$, we have the following $query$ and $createSub$ atoms:

$query(p(\theta(v1),\theta(v2),\theta(v3),0)$, $query(p_{d}(\theta(v3),\theta(v1),\theta(sk(v2,v1,v3)),1))$. 

Here $sk$ stands for the skolem function $skolemFn\_c\_x3$. 

We also have $createSub(subInst\_r_{c}(\theta(v2),\theta(v1),\theta(sk(v2,v1,v3)), \theta(v3)),1)$. Note that $\theta(v1)=t_{1},\theta(v2)=t_{2},\theta(v3)=t_{3}$, furthermore $q_{o}= query(p(v1,v2,v3),0)$. Now given $q_{f} = query(p(a_{1},a_{2},a_{3}),0)$ as above we have consider the following $AG2$ clause:
\begin{verbatim}
createSub(subInst_r_c(X1,X2,V_X3,X4),N):-createSub(subInst(V_X1,V_X2,V_X3,V_X4),N),
query(p(X2,X1,X4),N-1),0<N,N<M,max_ab_lvl(M).    
\end{verbatim}
We have the following instantiation of the clause above

$createSub(subInst\_r\_c(a_{2},a_{1},\theta(sk(v2,v1,v3)),a_{3}),1):-createSub(subInst\_r\_c(t_{2},t_{1},\theta(sk(v2,v1,v3)),t_{3}),1),q_{f}.$\\
Then via an instantiation of the following $AG1$ clause:
\begin{verbatim}
explains(p_d(X4,X2,X3),p(X1,X2,X4),N):-createSub(subInst_r_c(X1,X2,X3,X4),N).    
\end{verbatim}
and an instantiation of the following $AG1$ clause:
\begin{verbatim}
query(X,N):-explains(X,Y,N).    
\end{verbatim}
We get the following atom $query(p_{d}(a_{3},a_{1},\theta(sk(v2,v1,v3)),1)$ which is $tr(query(p_{d}(t_{3},t_{1},\theta(sk(v2,v1,v3))),1))$. Similarly for any other child node $q$ of $query(p(v1,v2,v3),0)$ in $G{R,p,N}$, we get $tr(q)$. Now it follows by a similar argument to before that for any child node $q'$ of these transformed level one nodes $q$, we also get $tr(q')$. One can see this by considering the following: Given a level one node $q$ from $G_{R,p,N}$, let $q_{c}^{1}$ be the image of $q$ under $\theta$, let $q_{o}^{1}$ be $q$ and let $q_{f}^{1}$ be $tr(q)$, then consider $\phi'$ = $T(\theta, q_{c}^{1},q_{o}^{1},q_{f}^{1})$. Then on any term $b$ in $q$, such that $b$ is in the set $\{v1,v2,v3\}$, $\phi'(b)$ =$\phi(b)$ and on all other terms $t$ in $G_{R,p,N}$, $\phi'(t)=\theta(t)$. Now, given the level one node $q$ in $G_{R,p,N}$, let $q'$ be a child node of $q$, then for any term $t'$ in $q'$, such that $t'$ occurs in the set $\{v1,v2,v3\}$, it must be the case that $t'$ occurs in $q$. Therefore, the result of applying $\phi'$ on $q'$ will in fact give us $tr(q')$ (recall that $tr$ corresponds to the transformation of $query$ atoms induced by $\phi$. In this way one can see that the term substitution given by $\phi$ will propogate all the way downwards over elements of $C_{R,p,N,\theta}$. This completes the case $k=0$. 

Now suppose we have proven the theorem for all values of $k<e$. Now let $q_{c},q_{o},q_{f}$ be such that the level of all these atoms in $e+1$, and let $q_{o}$ be $q_{o}$ does not correspond to a pre-condition of an input rule, where the pre-condition contains an existential variable. Now, let $q_{d}$ be the parent node of $q_{o}$. Let $r_{h}$ be the relevant rule and let the predicate corresponding to $q_{o}$ be $p_{z}$ and let the predicate corresponding to $q_{d}$ be $p_{y}$. Then due to an instantiation of a rule of the following form:
\begin{verbatim}
createSub(subInst_r_h(W''),e+1):-query(p_z(W_f),e+1),createSub(subInst_r_h(W'),o+1).
\end{verbatim}
where $query(p_{z}(W_{f}),e+1)$ = $q_{f}$, $W'$ is $\theta$ applied to the relevant set of terms $W$ from the abstract proof graph, and $W''$ is $\phi(W)$. Now due an instantiation of the following rule:
\begin{verbatim}
explains(p_z(W_f),p_y(U),e+1):-createSub(subInst_r_h(W''),e+1).
\end{verbatim} and the following $AG3$ rule:
\begin{verbatim}
query(Y,N-1):-explains(X,Y,N).    
\end{verbatim}
we get the atom $tr_{\phi}(q_{d})$. Now consider
$\phi'= T(\theta, \theta(q_{d}), q_{d}, tr_{\phi}(q_{d}))$, then $\phi'=\phi$
on the terms in $q_{d}$, that also appear in $q_{o}$, and $\phi' = \theta$ on
all other terms. However all the terms that appear in $q_{o}$ also appear in
$q_{d}$, since we assumed that $q_{o}$ did not have terms corresponding to
existential variables. Also the level of $q_{d}$ is $e$. Hence by the
inductive hypothesis we are done. Now, let $q_{c},q_{o},q_{f}$ be such that
some terms in the first argument of $q_{o}$ correspond to existential
variables. That is these terms are do not appear in the parent node of $q_{c}$
and are skolem functions whose input consists of terms in the parent node of
$q_{c}$. Let $V_{univ,q_{c}}$ consist of the set of terms in the first
argument of $q_{c}$ that correspond to universally quantified variables and
let $V_{ext,q_{c}}$ consist of the set of terms in the first argument of
$q_{c}$ that correspond to existentially quantified variables. Firstly,
consider $\phi'$ such that $\phi'=\phi$ on the terms in $V_{univ,q_{c}}$ and
$\phi' =\theta$ on all other terms in the abstract proof graph. Then given
this $\phi'$, note that we already get the concrete proof graph
$C_{R,p,n,\phi'}$, this is because, given the parent node $q'_{o}$, in the
abstract proof graph, we have $tr_{\phi'}(q'_{o})$ and since the level of
$q'_{o}$ is $e$, we know by the inductive hypothesis that the appropriate
transformation of the whole abstract proof graph follows. So in fact we to
prove the case where the level of $q_{c},q_{o},q_{f}$ is $e+1$, we can now
assume WLOG, that $q_{c_i}\neq q_{f_i}$ implies that $q_{o_i}$
corresponds to an existential variable where here $q_{c_i}$ denotes the
$i^{th}$ entry of the first argument of $q_{c}$ and similarly for the
others. So assume now that we are in this case and
$\phi= T(q_{c},q_{o},q_{f})$. Let $V'_{ext,q_{o}}$ be the set of terms in the
first argument of $q_{o}$ that correspond to existential variables. Now let
$q'_{o}$ be the parent node of $q_{o}$. Then due to the appropriate $AG2$ and
$AG3$ clauses, it follows that for all the child nodes $q''$ of $q'_{o}$, we
have $tr_{\phi}(q'')$. Due to a similar argument to the one we used for the
case $k=0$, it follows that for any descendant of $q_{d}$ of $q'_{o}$, we will
get $tr_{\phi}(q_{d})$. Now we claim that in the abstract proof graph, the
only nodes whose first entry contains terms from $V'_{ext,q_{o}}$ are
descendants of $q'_{o}$. Given a term $t$ from $V'_{ext,q_{o}}$, occurring in
a node $j$ of the minimal abstract proof graph, if $t$ does not correspond to
an existential variable in $j$, then since $t$ is not in the set
$\{v_{1},v_{2},..,v_{n}\}$, there exists some ancestor $j'$ of $j$ such that
$t$ corresponds to an existential variable in $j'$. Let $j_{p}$ be the parent
node of $j'$. Now, let $t$ be of the form
$skolemFn_{l_{b(g_{1},..,g_{m})}}$. Here $l$ refers to a input rule, $b$ refers
to some existential variable among the pre-conditons of $l$, and
$\{g_{1},g_{2},...,g_{m}\}$ refers to a fixed permutation of the arguments of
the post-condition of rule corresponding to $l$. However, from this we can
uniquely determine what the first entry of $j_{p}$ must be. Based on the order
$O_{l}$, the arguments of the relevant instantiation of the post-condition of
$l$ are given by some fixed permutation $\pi_{O_{l}}$ of
$\{g_{1},g_{2},...,g_{m}\}$. Therefore it follows that the first argument of
$j_{p}$ is in fact the same as that of $q'_{o}$. But now since we are working
with $\textit{minimal}$ abstract proof graphs it follows that
$j_{p} = q'_{o}$. This proves the claim. It now remains to show that we also have $I_{R,p,N,\phi}$. First note that in the preceeding part of the proof, whenever we used an Abducibles Generation clause to show how a transformed query atom leads to a transformed child atom, we used invoked clauses of the following from:
$createSub(t,i):-createSub(t',i),query(h,i-1).$\\
$explains(g,g',i):-createSub(t,i).$\\
$query(g,i):-explains(g,g',i).$\\
Notice that the $createSub$ atom in the right hand side of the first clause is always from $I_{R,p,N,\theta}$. Similarly for a transformed $query$ atom leading to the transformation of a sibling atom we have: $createSub(t,i):-createSub(t',i),query(h,i).$\\
$explains(g,g',i):-createSub(t,i).$\\
$query(g,i):-explains(g,g',i).$\\ 
and for transformation of a parent atom we have:\\
$createSub(t,i):-createSub(t',i),query(h,i).$\\
$explains(g,g',i):-createSub(t,i).$\\
$query(g',i-1):-explains(g,g',i).$\\
In each case the $createSub$ atom in the right hand side of the first clause is always from $I_{R,p,N,\theta}$ and a combination of such transformations creates the new concrete proof graph $C_{R,p,N,\phi}$. So in order to show that we have $I_{R,p,N,\theta}$, it is justified to first assume that we have $C_{R,p,N,\phi}$, $C_{R,p,N,\theta}$ and $I_{R,p,N,\theta}$. However this is now easy to see. given an atom $createSub(t',i)$ from $I_{R,p,N,\theta}$, the following instantions of $AG$ clauses shows how one gets the corresponding $createSub(t,i)$ atom from $I_{R,p,N,\phi}$.\\
$createSub(t_{1},i):-createSub(t_{0},i),tr(q_{b_{1}}).$\\
$createSub(t_{2},i):-createSub(t_{1},i),tr(q_{b_{2}}).$\\ ...\\
$createSub(t_{l},i):-createSub(t_{l-1},i),tr(q_{b_{l}}).$\\
$createSub(t_{l+1},i):-createSub(t_{l},i),tr(q_{h}).$\\
Here $createSub(t_{0},i) = createSub(t',i)$ and $createSub(t_{l+1},i) = createSub(t,i)$. $q_{b_{1}}$, $q_{b_{2}}$..., refer to query atoms in $C_{R,p,N\theta}$ that correspond to preconditions of the input rule instantiation given by $createSub(t',i)$, $tr(q)$ refers to the corresponding query atom of $q$ in $C_{R,p,N\phi}$, finally $q_{h}$ refers to the post condition of the input rule instantiation given by $createSub(t',i)$. 

\input{derivation_tree_figure}


 
\begin{corollary}[Adding facts]\label{addfact}
Given a rule set $R$ satisfying condition 4 from above consider $\langle R,q,U,C,N\rangle$, let $p$ be the predicate corresponding to $q$. Suppose $A$ is an answer set of $P^{semi-complete}_{<R,q,U,C,N>}$ and let $A$ contain $C_{R,p,N,\theta}$. Now say the atom $q_{c}$ $query(p_{i}(t_{1},t_{2},..,t_{j}),k)$ is in $C_{R,p,N,\theta}$. Let $q_{o}$ be some query atom from the set $S_{q_{c}}$ given by $query((e_{1},e_{2},...,e_{j}),k)$. Now suppose, $h_{f}= holds((a_{1},a_{2},...,a_{j}))$ is an arbitrary $holds$ atom such that the map $\psi$ from the $e_{i}s$ to the $a_{i}s$ as described in the definition above is well defined. Then upon adding the fact $holds(p_{i}(a_{1},a_{2},..,a_{j}))$ to $P^{semi-complete}_{<R,q,U,C,N>}$, the resulting program has an answer set $A'$ such that $A'$ contains $C_{R,p,N,\phi}$, where $\phi = T(\theta, q_{c}, q_{o}, q_{f})$, where $q_{f} = query(p_{i}(a_{1},a_{2},..,a_{j}),k)$. 
\end{corollary}
\textit{Proof} Given $q_{o}$, let $i_{o}$ be from the set $I_{R,p,N}$ such that $q_{o}$ corresponds to some input-rule precondition corresponding to $i_{o}$. Then given $q_{c}$, and $tr_{\theta}(i_{o})$, then consider the following instantiation of an $AG2$ clause. $tr_{\phi}(i_{o}):-tr_{\theta}(i_{o}),h_{f}$. Then due to an application of the $explains(...):-createSub(...)$ clause and the use of the following $AG3$ rule:
$query(X,N):-explains(X,Y,N)$, we get the required atom $q_{f}$, where the
first entry of $q_{f}$ is $h_{f}$ and the level of $q_{f}$ is the same as
$q_{c},q_{o}$. So then the theorem above applies. In the case where $q_{o},
i_{o}$ are such that $q_{o}$ corresponds to a post-condition, we invoke the
$AG3$ rule $query(Y,N-1):-explains(X,Y,N)$ instead.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
